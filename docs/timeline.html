<!DOCTYPE html>
<html>
<body>

<h1> title </h1>

<strong>Select topic</strong><br>

<select name="cars" id="select" onChange="handledropdown(this)">
  <option value="all">All</option>
</select><br>

<strong>Clickable timeline</strong><br>
<div id="canvasdiv" style="position: relative;">
<canvas id="myCanvas" width="2000" height="2000" style="position: absolute; left: 0px; top: 0px; z-index: 0; border:1px solid #d3d3d3;">
Your browser does not support the HTML5 canvas tag.</canvas>
<canvas id="toplayer" width="20" height="30" style="position: absolute; left: 10px; top: 10px; z-index: 1; border:0px;"></canvas>
</div>


<script>

'use strict';

var canvas = document.getElementById('myCanvas');

var canvasHeight = canvas.height;
var canvasWidth = canvas.width;
console.log("Canvas: " + canvasHeight + "x" + canvasHeight); 

var ctx = canvas.getContext('2d');

canvas.addEventListener('click', function(event) {
    var canvasdiv =  document.getElementById('canvasdiv');
    //console.log(canvasdiv.offsetLeft + ";" + canvasdiv.offsetTop);
    //console.log(canvas.clientLeft + "!" + canvas.clientTop);
    //console.log(canvas.offsetLeft + "|" + canvas.offsetTop);
    //console.log(event.pageX + ":" + event.pageY);
    var x = event.pageX - canvas.clientLeft - canvasdiv.offsetLeft;
    var y = event.pageY - canvas.clientTop - canvasdiv.offsetTop;
    //ctx.fillText(yPixelToYear(y, 100),x,y);
    var c2 = document.getElementById('toplayer');
    c2.style.left = x+"px";
    c2.style.top = y+"px";
    var ctx2 = c2.getContext('2d');
    //ctx2.clearRect(0, 0, c2.width, c2.height);
    ctx2.fillStyle = "yellow";
    ctx2.fillRect(0, 0, c2.width, c2.height);
    ctx2.fillStyle = "black";
    ctx2.fillText(yPixelToYear(y,100), 0, 15);
});

function handledropdown(e) {
  console.log("changed");
  console.log(globalData.people[0].name);
}

// time span
var startYear = 1800;
var endYear = 1900;

// timeline formating parameters
var timelineXMargin = 5;
var timelineYMargin = 5;
var tickLength = 10;
var tickYearGap = 2;
var textHeight = ctx.measureText('M').width;
var lifeEndRadius = 10;
var lifeWidth = 2;
var lifeSeparation = (2 * lifeEndRadius) + lifeWidth;


function yearToYPixel(year, numYears) {
  return timelineYMargin + (year * (canvasHeight-(2*timelineYMargin)) / numYears);
}

function yPixelToYear(y, numYears) {
  return Math.round((numYears * (y - timelineYMargin))/(canvasHeight-(2*timelineYMargin)));
}

ctx.beginPath();
ctx.lineWidth = "3";
ctx.strokeStyle = "red";
ctx.moveTo(timelineXMargin, timelineYMargin);
ctx.lineTo(timelineXMargin, canvasHeight - timelineYMargin);
ctx.stroke();

ctx.beginPath();
ctx.linewidth = "3";
ctx.strokeStyle = "red";
var i;
var yearWidth = 0;
for (i = 0; i <= (endYear - startYear); i++) {
  ctx.moveTo(timelineXMargin, yearToYPixel(i, endYear - startYear));
  ctx.lineTo(timelineXMargin + tickLength, yearToYPixel(i, endYear - startYear));
  ctx.fillText(startYear+i, timelineXMargin + tickLength + tickYearGap, yearToYPixel(i, endYear - startYear) + (textHeight/2) );
  if (ctx.measureText(startYear+i).width > yearWidth) {
    yearWidth = ctx.measureText(startYear+i).width;
  }
}
ctx.stroke();

console.log("Year Width = "+yearWidth);

var url = "";
if (window.location.href.startsWith("file:"))
{
  console.log("Local HTML");
  url = "https://petesndrs.github.io/timeline/timeline.json";
}
else
{
  console.log("Server HTML");
  url = "./timeline.json"
}


function fetchData() {
  return window.fetch(url).then(function(response) {
  console.log(response.status)
  return response.json();
}).then(function(data) {
  console.log(data);
  console.log("Fetch Done");
  return data;
}).catch(function(err) {
  console.log("Caught: " + err);
});
}

var globalData;

function doData(data) {
  var select = document.getElementById('select');
  var xStart = timelineXMargin + tickLength + tickYearGap + yearWidth + lifeEndRadius + lifeWidth;

  globalData = data;

  const mySet1 = new Set();
  var i;
  for (i in data.people) {
    console.log("> " + data.people[i].name + " " + data.people[i].born + " " + data.people[i].died);
    ctx.beginPath();
    ctx.lineWidth = lifeWidth;
    ctx.strokeStyle = "blue";
    ctx.arc(xStart + (i * lifeSeparation), yearToYPixel(data.people[i].born - startYear, endYear - startYear), lifeEndRadius, Math.PI/2, 5 * Math.PI/2, false);
    ctx.arc(xStart + (i * lifeSeparation), yearToYPixel(data.people[i].died - startYear, endYear - startYear), lifeEndRadius, 3 * Math.PI/2, 7 * Math.PI/2, false);
    //ctx.arc(50, yearToYPixel( 1820 - startYear, endYear - startYear), 10, Math.PI/2, 5 * Math.PI/2, false);
    //ctx.arc(50, yearToYPixel( 1830 - startYear, endYear - startYear), 10, 3 * Math.PI/2, 7 * Math.PI/2, false);
    ctx.stroke();

    var j;
    for (j in data.people[i].fields) {
       console.log("= " + data.people[i].fields[j].field);
       mySet1.add(data.people[i].fields[j].field);
    }

  }

  console.log(mySet1);

  var index = 1;
  mySet1.forEach(function(value,key,set) {
    console.log(value);
    var opt = document.createElement("option");
    opt.value= index;
    opt.innerHTML = value;
    select.appendChild(opt);
    index++;
  });

  console.log("Data Done");
}

var d = fetchData();
d.then(function(data){doData(data)});

</script>

</body>
</html>
