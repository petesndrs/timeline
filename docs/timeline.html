<!DOCTYPE html>
<html>
<body>

<h1> title </h1>

<strong>Select topic</strong><br>

<select name="cars" id="select">
  <option value="all">All</option>
</select><br>

<strong>Clickable timeline</strong><br>
<div style='overflow:auto'>
<canvas id="myCanvas" width="2000" height="2000" style="border:1px solid #d3d3d3;">
Your browser does not support the HTML5 canvas tag.</canvas>
</div>

<script>

'use strict';

var canvas = document.getElementById('myCanvas');

var canvasHeight = canvas.height;
var canvasWidth = canvas.width;
console.log("Canvas: " + canvasHeight + "x" + canvasHeight); 

var ctx = canvas.getContext('2d');

canvas.addEventListener('click', function(event) {
    var elemLeft = canvas.offsetLeft + canvas.clientLeft;
    var elemTop = canvas.offsetTop + canvas.clientTop;
    var x = event.pageX - elemLeft;
    var y = event.pageY - elemTop;
	ctx.fillText(yPixelToYear(y, 100),x,y);
	});


// time span
var startYear = 1800;
var endYear = 1900;

// timeline formating parameters
var timelineXMargin = 5;
var timelineYMargin = 5;
var tickLength = 10;
var tickYearGap = 2;
var textHeight = ctx.measureText('M').width;
var lifeEndRadius = 10;
var lifeWidth = 2;
var lifeSeparation = (2 * lifeEndRadius) + lifeWidth;


function yearToYPixel(year, numYears) {
  return timelineYMargin + (year * (canvasHeight-(2*timelineYMargin)) / numYears);
}

function yPixelToYear(y, numYears) {
  return Math.round((numYears * (y - timelineYMargin))/(canvasHeight-(2*timelineYMargin)));
}

ctx.beginPath();
ctx.lineWidth = "3";
ctx.strokeStyle = "red";
ctx.moveTo(timelineXMargin, timelineYMargin);
ctx.lineTo(timelineXMargin, canvasHeight - timelineYMargin);
ctx.stroke();

ctx.beginPath();
ctx.linewidth = "3";
ctx.strokeStyle = "red";
var i;
var yearWidth = 0;
for (i = 0; i <= (endYear - startYear); i++) {
  ctx.moveTo(timelineXMargin, yearToYPixel(i, endYear - startYear));
  ctx.lineTo(timelineXMargin + tickLength, yearToYPixel(i, endYear - startYear));
  ctx.fillText(startYear+i, timelineXMargin + tickLength + tickYearGap, yearToYPixel(i, endYear - startYear) + (textHeight/2) );
  if (ctx.measureText(startYear+i).width > yearWidth) {
    yearWidth = ctx.measureText(startYear+i).width;
  }
}
ctx.stroke();

console.log("Year Width = "+yearWidth);

var url = "";
if (window.location.href.startsWith("file:"))
{
  console.log("Local HTML");
  url = "https://petesndrs.github.io/timeline/timeline.json";
}
else
{
  console.log("Server HTML");
  url = "./timeline.json"
}


function fetchData() {
  return window.fetch(url).then(function(response) {
  console.log(response.status)
  return response.json();
}).then(function(data) {
  console.log(data);
  console.log("Fetch Done");
  return data;
}).catch(function(err) {
  console.log("Caught: " + err);
});
}

function doData(data) {
  var select = document.getElementById('select');
  var index = 1;
  var xStart = timelineXMargin + tickLength + tickYearGap + yearWidth + lifeEndRadius + lifeWidth;
  var i;
  for (i in data.people) {
    console.log("> " + data.people[i].name + " " + data.people[i].born + " " + data.people[i].died);
    ctx.beginPath();
    ctx.lineWidth = lifeWidth;
    ctx.strokeStyle = "blue";
    ctx.arc(xStart + (i * lifeSeparation), yearToYPixel(data.people[i].born - startYear, endYear - startYear), lifeEndRadius, Math.PI/2, 5 * Math.PI/2, false);
    ctx.arc(xStart + (i * lifeSeparation), yearToYPixel(data.people[i].died - startYear, endYear - startYear), lifeEndRadius, 3 * Math.PI/2, 7 * Math.PI/2, false);
    //ctx.arc(50, yearToYPixel( 1820 - startYear, endYear - startYear), 10, Math.PI/2, 5 * Math.PI/2, false);
    //ctx.arc(50, yearToYPixel( 1830 - startYear, endYear - startYear), 10, 3 * Math.PI/2, 7 * Math.PI/2, false);
    ctx.stroke();

    var opt = document.createElement("option");
    opt.value= index;
    opt.innerHTML = data.people[i].name;
    select.appendChild(opt);
    index++;
  }
  console.log("Data Done");
}

var d = fetchData();
d.then(function(data){doData(data)});

</script>

</body>
</html>
